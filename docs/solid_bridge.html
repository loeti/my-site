<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Solid Bridge</title>
                <script type="module">
                    import { Session } from 'https://esm.sh/@inrupt/solid-client-authn-browser?bundle';
                    import { getSolidDataset, getThing, getStringNoLocale, overwriteFile } from 'https://esm.sh/@inrupt/solid-client?bundle';
                    import { VCARD, FOAF } from 'https://esm.sh/@inrupt/vocab-common-rdf?bundle';
                    
                    const session = new Session({secureStorage: window.localStorage, keepAlive: true});
                    
                    window.refresh = async function() {
                        const currentUrl = window.location.href;
                        
                        try {
                            await session.handleIncomingRedirect({ restorePreviousSession: true });
                            if (session.info.isLoggedIn) {
                                sendMessage("success", session.info.webId);
                            } else {
                                sendMessage("restoreFailed", "loggedOut");
                            }
                        } catch (e) {
                            sendMessage("error", "redirection failed: " + e.toString());
                        }
                    }
                    
                    
                    window.startSolidLogin = async function(oidcIssuer, clientId, redirectUrl) {
                        try {
                            await session.login({
                                oidcIssuer: oidcIssuer,
                                clientId: clientId,
                                redirectUrl: redirectUrl
                            });
                        } catch (error) {
                            sendMessage("error", "login failed: " + error.toString());
                        }
                    };
                    
                    window.logout = async function() {
                        try {
                            await session.logout({
                                logoutType: 'app',
                            });
                        } catch (error) {
                            sendMessage("error", "logout app failed: " + error.toString());
                        }
                    }
                    
                    window.logoutIdp = async function(redirectUrl) {
                        try {
                            await session.logout({
                                logoutType: 'idp',
                                postLogoutUrl: redirectUrl,
                                state: "loggedout"
                            });
                        } catch (error) {
                            sendMessage("error", "logout idp failed: " + error.toString());
                        }
                    }
                    
                    window.writeTestFile = async function(webId, message, filename) {
                        try {
                            const podRoot = webId.replace("profile/card#me", "");
                            const targetUrl = podRoot + "private/" + filename;
                            const file = new Blob([message], { type: "text/plain" });
                            
                            await overwriteFile(targetUrl,
                                                file,
                                                { contentType: "text/plain", fetch: session.fetch });
                                                
                                                sendMessage("writeSuccess", targetUrl);
                        } catch (error) {
                            sendMessage("error", "file write failed: " + error.toString());
                        }
                    };
                    
                    window.fetchProfileName = async function(webId) {
                        try {
                            const myDataset = await getSolidDataset(webId, { fetch: session.fetch });
                            const profile = getThing(myDataset, webId);
                            const name = getStringNoLocale(profile, VCARD.fn)
                            || getStringNoLocale(profile, FOAF.name)
                            || "Anonymous user";

                            sendMessage("profileName", name);
                        } catch (error) {
                            sendMessage("error", "profile read failed: " + error.toString());
                        }
                    }

                    window.fetchProfileBirthdate = async function(webId) {
                        try {
                            const myDataset = await getSolidDataset(webId, { fetch: session.fetch });
                            const profile = getThing(myDataset, webId);
                            const bday = getStringNoLocale(profile, VCARD.bday) || "";

                            sendMessage("profileBirthdate", bday);
                        } catch (error) {
                            sendMessage("error", "birthdate read failed: " + error.toString());
                        }
                    }
                    
                    function sendMessage(type, payload) {
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.solidAuth) {
                            window.webkit.messageHandlers.solidAuth.postMessage({ "type": type, "payload": payload });
                        }
                    }
                    
                    refresh();
                    
                </script>
            </head>
    <body style="font-family: -apple-system, sans-serif; text-align: center; padding-top: 50px;">
        <h2>Solid Login</h2>
    </body>
</html>

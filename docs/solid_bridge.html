<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Solid Bridge</title>
                <script type="module">
                    import { Session } from 'https://esm.sh/@inrupt/solid-client-authn-browser?bundle';
                    import { getSolidDataset, getThing, getStringNoLocale, overwriteFile } from 'https://esm.sh/@inrupt/solid-client?bundle';
                    import { VCARD, FOAF } from 'https://esm.sh/@inrupt/vocab-common-rdf?bundle';
                
                    const session = new Session();
                    
                    async function initSolid() {
                        const currentUrl = window.location.href;
                        console.log("üåê Bridge geladen auf: " + currentUrl);
                        
                        // Fall A: Wir kommen gerade vom Login zur√ºck (Code in der URL)
                        if (currentUrl.includes("code=") || currentUrl.includes("state=")) {
                            console.log("üì• Auth-Parameter gefunden! Verarbeite Login...");
                            try {
                                await session.handleIncomingRedirect({
                                    url: currentUrl,
                                    restorePreviousSession: true
                                });
                                console.log("‚úÖ Login komplett!");
                                sendMessage("success", session.info.webId);
                                
                                // Adresszeile aufr√§umen, damit bei einem Reload nicht nochmal der Code verarbeitet wird
                                window.history.replaceState({}, document.title, window.location.pathname);
                            } catch (e) {
                                sendMessage("error", "Redirect-Fehler: " + e.toString());
                            }
                        }
                        // Fall B: Normaler Start / App Neustart
                        else {
                            console.log("üîÑ Versuche Session √ºber Refresh Token wiederherzustellen...");
                            try {
                                // HIER nutzt Inrupt jetzt den gespeicherten Refresh Token anstatt des blockierten iframes!
                                await session.handleIncomingRedirect({ restorePreviousSession: true });
                                
                                if (session.info.isLoggedIn) {
                                    console.log("‚úÖ BAM! Session erfolgreich wiederhergestellt!");
                                    sendMessage("success", session.info.webId);
                                } else {
                                    console.log("‚ÑπÔ∏è Keine aktive Session gefunden. Bitte einloggen.");
                                    sendMessage("status", "loggedOut");
                                }
                            } catch (e) {
                                console.log("Wiederherstellung fehlgeschlagen:", e);
                                sendMessage("status", "loggedOut");
                            }
                        }
                    }

                     window.startSolidLogin = async function(providerUrl, clientId, redirectUrl) {
                        try {
                            await session.login({
                                oidcIssuer: providerUrl,
                                clientId: clientId,
                                redirectUrl: redirectUrl
                            });
                        } catch (error) {
                            sendMessage("error", "Login-Fehler: " + error.toString());
                        }
                    };
                    
                    window.writeTestFile = async function(webId, message, filename) {
                        try {
                            const podRoot = webId.replace("profile/card#me", "");
                            
                            const targetUrl = podRoot + "private/" + filename;
                            
                            const file = new Blob([message], { type: "text/plain" });
                            
                            await overwriteFile(targetUrl,
                                                file,
                                                { contentType: "text/plain", fetch: session.fetch });
                                                
                            sendMessage("writeSuccess", targetUrl);
                        } catch (error) {
                            sendMessage("error", "Konnte Datei nicht schreiben: " + error.toString());
                        }
                    };
                    
                    window.fetchProfileName = async function(webId) {
                        try {
                            const myDataset = await getSolidDataset(webId, { fetch: session.fetch });
                            
                            const profile = getThing(myDataset, webId);
                            
                            const name = getStringNoLocale(profile, VCARD.fn)
                            || getStringNoLocale(profile, FOAF.name)
                            || "Anonymer Pod-Nutzer";
                            
                            sendMessage("profileName", name);
                        } catch (error) {
                            sendMessage("error", "Konnte Profil nicht lesen: " + error.toString());
                        }
                    }
                    
                    function sendMessage(type, payload) {
                        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.solidAuth) {
                            window.webkit.messageHandlers.solidAuth.postMessage({ "type": type, "payload": payload });
                        }
                    }
                    
                    initSolid();
                </script>
    </head>
    <body style="font-family: -apple-system, sans-serif; text-align: center; padding-top: 50px;">
        <h2>Solid Login...</h2>
    </body>
</html>
